{% extends 'shared/base.html' %}
{% block title %}Book Parking - Vehicle Parking System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>Book a Parking Spot</h2>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <form method="POST" action="{{ url_for('user.book_parking') }}" id="bookingForm">
            {{ form.hidden_tag() }}
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Booking Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="parking_lot_id" class="form-label">Select Parking Lot:</label>
                        <select class="form-select" id="parking_lot_id" name="parking_lot_id" required>
                            <option value="">-- Select Parking Lot --</option>
                            {% for lot in parking_lots %}
                                <option value="{{ lot.id }}" {% if selected_lot_id == lot.id %}selected{% endif %}>
                                    {{ lot.name }} ({{ lot.available_spots }} spots available) - ${{ lot.price }}/hr
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select Vehicle:</label>
                        {% for vehicle in user_vehicles %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="vehicle_id" 
                                       id="vehicle_{{ vehicle.id }}" value="{{ vehicle.id }}"
                                       {% if selected_vehicle_id == vehicle.id or loop.first %}checked{% endif %}>
                                <label class="form-check-label" for="vehicle_{{ vehicle.id }}">
                                    {{ vehicle.model }} ({{ vehicle.license_plate }}) - {{ vehicle.vehicle_type }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        <label for="duration" class="form-label">Estimated Duration (hours):</label>
                        <input type="number" class="form-control" id="duration" name="duration" value="1" min="1" max="24" required>
                    </div>

                    <div class="mb-3">
                        <label for="entry_time" class="form-label">Entry Time:</label>
                        <input type="datetime-local" class="form-control" id="entry_time" name="entry_time" required>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Find Available Spots</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="col-md-7">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Available Parking Spots</h5>
            </div>
            <div class="card-body">
                {% if available_spots %}
                    <div class="alert alert-success">
                        <strong>{{ available_spots|length }}</strong> spot{{ 's' if available_spots|length != 1 else '' }} available at 
                        <strong>{{ available_spots[0].parking_lot.name }}</strong>
                    </div>

                    <div class="row mb-3">
                        {% for spot in available_spots %}
                        <div class="col-md-3 col-4 mb-3">
                            <div class="parking-spot available" 
                                 data-spot-id="{{ spot.id }}" 
                                 data-spot-number="{{ spot.spot_number }}" 
                                 data-spot-type="{{ spot.spot_type }}">
                                <div class="text-center">
                                    <strong>{{ spot.spot_number }}</strong><br>
                                    <small>{{ spot.spot_type|capitalize }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        <div class="card p-3 bg-light">
                            <div class="row">
                                <div class="col-md-6">
                                    <p id="selectedSpotDisplay"><strong>Selected Spot:</strong> None</p>
                                    Spot Type: <strong><span id="selected_spot_type">-</span></strong>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    Duration: <strong><span id="duration_display">1</span> hours</strong><br>
                                    Estimated Fee: <strong>$<span id="estimated_fee">0.00</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form method="POST" action="{{ url_for('user.book_parking') }}" id="confirmationForm">
                        {{ confirmation_form.hidden_tag() }}
                        <input type="hidden" name="spot_id" id="spot_id" value="">
                        <input type="hidden" name="vehicle_id" id="confirm_vehicle_id">
                        <input type="hidden" name="duration" id="confirm_duration">
                        <input type="hidden" name="entry_time" id="confirm_entry_time">
                        <input type="hidden" name="parking_lot_id" id="confirm_parking_lot_id">
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="confirm_btn" disabled>Confirm Booking</button>
                        </div>
                    </form>
                {% else %}
                    <p class="text-muted text-center">Please select a parking lot and click "Find Available Spots".</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.parking-spot {
    border: 2px solid #ccc;
    border-radius: 6px;
    padding: 10px;
    cursor: pointer;
    background-color: #f8f9fa;
    text-align: center;
    transition: 0.2s;
}
.parking-spot.available:hover {
    background-color: #e2f0d9;
}
.parking-spot.active {
    border-color: #007bff;
    background-color: rgba(0, 123, 255, 0.1);
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const entryField = document.getElementById('entry_time');
    if (entryField) entryField.value = now.toISOString().slice(0, 16);

    const spots = document.querySelectorAll('.parking-spot.available');
    const spotIdInput = document.getElementById('spot_id');
    const selectedSpotDisplay = document.getElementById('selectedSpotDisplay');
    const confirmBtn = document.getElementById('confirm_btn');

    spots.forEach(spot => {
        spot.addEventListener('click', function () {
            spots.forEach(s => s.classList.remove('selected'));
            this.classList.add('selected');

            const spotId = this.getAttribute('data-spot-id');
            spotIdInput.value = spotId;
            if (selectedSpotDisplay) {
                selectedSpotDisplay.innerHTML = `<strong>Selected Spot:</strong> ${spotId}`;
            }
            if (confirmBtn) confirmBtn.disabled = false;
            updateEstimatedFee();
            updateConfirmForm();
        });
    });

    document.getElementById('duration').addEventListener('input', () => {
        document.getElementById('duration_display').textContent = document.getElementById('duration').value;
        updateEstimatedFee();
        updateConfirmForm();
    });

    updateConfirmForm();
});

function updateEstimatedFee() {
    const duration = parseFloat(document.getElementById('duration').value || 0);
    const lotSelect = document.getElementById('parking_lot_id');
    const lotText = lotSelect.options[lotSelect.selectedIndex]?.text || '';
    const match = lotText.match(/\$([0-9.]+)\s*\/hr/);
    const rate = match ? parseFloat(match[1]) : 0;
    document.getElementById('estimated_fee').textContent = (duration * rate).toFixed(2);
}

function updateConfirmForm() {
    const vehicleId = document.querySelector('input[name="vehicle_id"]:checked')?.value;
    const duration = document.getElementById('duration').value;
    const entryTime = document.getElementById('entry_time').value;
    const parkingLotId = document.getElementById('parking_lot_id').value;

    document.getElementById('confirm_vehicle_id').value = vehicleId || '';
    document.getElementById('confirm_duration').value = duration || '';
    document.getElementById('confirm_entry_time').value = entryTime || '';
    document.getElementById('confirm_parking_lot_id').value = parkingLotId || '';
}
</script>
{% endblock %}
